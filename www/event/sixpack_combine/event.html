<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>호치킨 세트메이커</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #2e6b2c;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .center-image {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            height: auto;
        }

        .image-container {
            position: relative;
            max-width: 300px;
        }

        /* 개별 조각을 제어하는 클래스 */
        .box-piece-top-left {
            position: absolute;
            top: 25.5%;
            left: 25.3%;
            transform: translate(-50%, -49.5%) scale(0.96);
            width: 50%;
            height: auto;
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
        }

        .box-piece-top-center {
            position: absolute;
            top: 25.5%;
            left: 50%;
            transform: translate(-50%, -49.5%) rotate(180deg) scale(0.96);
            width: 50%;
            height: auto;
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
        }
        
        .box-piece-top-right {
            position: absolute;
            top: 25.5%;
            left: 74.7%;
            transform: translate(-50%, -49.5%) scale(0.96);
            width: 50%;
            height: auto;
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
        }

        .box-piece-bottom-left {
            position: absolute;
            top: 74.5%;
            left: 25.3%;
            transform: translate(-50%, -50.5%) rotate(180deg) scale(0.96);
            width: 50%;
            height: auto;
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
        }
        
        .box-piece-bottom-large {
            position: absolute;
            top: 74.5%;
            left: 74.7%;
            transform: translate(-75%, -50.5%) scale(1.45);
            width: 50%;
            height: auto;
            clip-path: polygon(25% 0%, 100% 0%, 75% 100%, 0% 100%);
        }
        
        .menu-tab {
            cursor: pointer;
            padding: 8px 16px;
            border-bottom: 2px solid transparent;
        }
        .menu-tab.active {
            font-weight: bold;
            border-bottom: 2px solid #fff;
        }

        .menu-item-img {
            cursor: move;
        }

        .main-content {
            max-width: 600px;
            margin: 0 auto;
            background-color: #2e6b2c;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .main-content {
                max-width: 100%;
                border-radius: 0;
            }
        }

        #message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            display: none;
        }
        
        .highlight-piece {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: auto;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .highlight-piece-top-left {
            top: 25.5%;
            left: 25.3%;
            transform: translate(-50%, -49.5%) scale(0.96);
        }

        .highlight-piece-top-center {
            top: 25.5%;
            left: 50%;
            transform: translate(-50%, -49.5%) rotate(180deg) scale(0.96);
        }
        
        .highlight-piece-top-right {
            top: 25.5%;
            left: 74.7%;
            transform: translate(-50%, -49.5%) scale(0.96);
        }

        .highlight-piece-bottom-left {
            top: 74.5%;
            left: 25.3%;
            transform: translate(-50%, -50.5%) rotate(180deg) scale(0.96);
        }
        
        .highlight-piece-bottom-large {
            position: absolute;
            top: 74.5%;
            left: 74.7%;
            transform: translate(-75%, -50.5%) scale(1.45);
            width: 50%;
            clip-path: polygon(25% 0%, 100% 0%, 75% 100%, 0% 100%);
        }
    </style>
</head>
<body class="p-8">

    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold">호치킨 세트메이커</h1>
    </header>

    <main class="main-content">
        <div class="text-center mb-6">
            <h2 class="text-xl font-bold">이벤트 내용</h2>
            <p class="text-sm mt-2">이벤트 참여 방법 설명</p>
        </div>

        <div class="border-b border-white border-opacity-30 mb-6"></div>

        <h2 class="text-center text-2xl font-bold mb-6">직접 만들기</h2>

        <div class="flex justify-center items-center">
            <div class="image-container" id="drop-container">
                <img src="./images/box_white.png" alt="box_white" class="center-image">
                <img src="./images/box_piece.png" alt="box_piece" class="box-piece-top-left" data-slot="0">
                <img src="./images/box_piece.png" alt="box_piece" class="box-piece-top-center" data-slot="1">
                <img src="./images/box_piece.png" alt="box_piece" class="box-piece-top-right" data-slot="2">
                <img src="./images/box_piece.png" alt="box_piece" class="box-piece-bottom-left" data-slot="3">
                <img src="./images/box_piece2.png" alt="box_piece_large" class="box-piece-bottom-large" data-slot="4">
                
                <img id="highlight-0" src="./images/box_piece_y.png" alt="highlight" class="highlight-piece highlight-piece-top-left">
                <img id="highlight-1" src="./images/box_piece_y.png" alt="highlight" class="highlight-piece highlight-piece-top-center">
                <img id="highlight-2" src="./images/box_piece_y.png" alt="highlight" class="highlight-piece highlight-piece-top-right">
                <img id="highlight-3" src="./images/box_piece_y.png" alt="highlight" class="highlight-piece highlight-piece-bottom-left">
                <img id="highlight-4" src="./images/box_piece2_y.png" alt="highlight" class="highlight-piece highlight-piece-bottom-large">
            </div>
        </div>

        <div class="border-b border-white border-opacity-30 my-6"></div>

        <div class="text-center mb-6">
            <h2 class="text-xl font-bold">메뉴 확장</h2>
            <div class="flex justify-center space-x-4">
                <div id="chicken-tab" class="menu-tab active">치킨류</div>
                <div id="side1-tab" class="menu-tab">사이드1</div>
                <div id="side2-tab" class="menu-tab">사이드2</div>
            </div>
            <div id="menu-gallery" class="grid grid-cols-3 gap-4 mt-4">
            </div>
        </div>

        <div class="border-b border-white border-opacity-30 my-6"></div>

        <h2 class="text-center text-2xl font-bold mb-6">제출하기</h2>
        <form id="event-form" action="submit.php" method="post" class="space-y-4">
            <input type="text" name="user_name" placeholder="성함 *" class="w-full p-2 rounded-md bg-white bg-opacity-10 focus:outline-none focus:ring-2 focus:ring-yellow-400">
            <input type="text" name="user_contact" placeholder="연락처 *" class="w-full p-2 rounded-md bg-white bg-opacity-10 focus:outline-none focus:ring-2 focus:ring-yellow-400">
            <input type="text" name="set_name" placeholder="내가 만드는 세트 이름 *" class="w-full p-2 rounded-md bg-white bg-opacity-10 focus:outline-none focus:ring-2 focus:ring-ring-yellow-400">
            <textarea name="set_description" placeholder="세트 설명" rows="4" class="w-full p-2 rounded-md bg-white bg-opacity-10 focus:outline-none focus:ring-2 focus:ring-yellow-400"></textarea>
            <div class="text-xs">
                <input type="checkbox" id="consent" name="consent" class="mr-2">
                <label for="consent">개인정보 제공 관련 항목에 동의합니다. *</label>
            </div>
            <input type="hidden" id="menu_1" name="menu_1">
            <input type="hidden" id="menu_2" name="menu_2">
            <input type="hidden" id="menu_3" name="menu_3">
            <input type="hidden" id="menu_4" name="menu_4">
            <input type="hidden" id="menu_5" name="menu_5">

            <p id="error-message" class="text-red-400 text-sm text-center"></p>
            <button type="submit" class="w-full py-3 mt-4 rounded-full bg-white text-[#2e6b2c] font-bold shadow-lg hover:bg-gray-200 transition-colors">
                이벤트 참여하기
            </button>
        </form>
    </main>

    <div id="message-box" class="hidden">
      <p id="message-text" class="text-center"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const menuData = {
                'chicken': [
                    { name: '크리스피순살', src: './images/product/chicken/크리스피순살.png' },
                    { name: '양념순살', src: './images/product/chicken/양념순살.png' },
                    { name: '간장순살', src: './images/product/chicken/간장순살.png' },
                    { name: '치즈찐', src: './images/product/chicken/치즈찐.png' },
                    { name: '맛나게맵닭', src: './images/product/chicken/맛나게맵닭.png' },
                    { name: '치타치킨', src: './images/product/chicken/치타치킨.png' },
                    { name: '고추똥집튀김', src: './images/product/chicken/고추똥집튀김.png' },
                    { name: '페퍼스틱', src: './images/product/chicken/페퍼스틱.png' },
                    { name: '크런치윙봉', src: './images/product/chicken/크런치윙봉.png' },
                ],
                'side1': [
                    { name: '스푼떡볶이', src: './images/product/side1/스푼떡볶이.png' },
                    { name: '누들로제떡볶이', src: './images/product/side1/누들로제떡볶이.png' },
                    { name: '매콤비빔쫄면', src: './images/product/side1/매콤비빔쫄면.png' },
                    { name: '라구스파게티', src: './images/product/side1/라구스파게티.png' },
                ],
                'side2': [
                    { name: '케이준후라이', src: './images/product/side2/케이준후라이.png' },
                    { name: '스노윙후라이', src: './images/product/side2/스노윙후라이.png' },
                    { name: '치타후라이', src: './images/product/side2/치타후라이.png' },
                    { name: '치즈볼', src: './images/product/side2/치즈볼.png' },
                    { name: '탱글새우튀김', src: './images/product/side2/탱글새우튀김.png' },
                ]
            };

            const menuGallery = document.getElementById('menu-gallery');
            const tabs = document.querySelectorAll('.menu-tab');
            const highlightPieces = document.querySelectorAll('.highlight-piece');
            
            // ✨ 드래그 상태를 관리할 변수들
            let draggedElement = null;
            let draggedMenuName = null;
            let draggedOriginalSrc = null;
            let draggedCategory = null; // ✨ 드래그하는 메뉴의 카테고리를 저장할 변수 추가

            // ✨ 드롭이 허용되는 위치인지 확인하는 헬퍼 함수
            function isDropAllowed(category, slot) {
                if (!category || slot === undefined) return false;
                const chickenSlots = ['0', '1', '2']; // 치킨류: 슬롯 1, 2, 3번
                const side1Slot = '4'; // 사이드1: 슬롯 4번 (마름모)
                const side2Slot = '3'; // 사이드2: 슬롯 5번

                if (category === 'chicken' && chickenSlots.includes(slot)) return true;
                if (category === 'side1' && slot === side1Slot) return true;
                if (category === 'side2' && slot === side2Slot) return true;
                
                return false;
            }

            function showMessage(text) {
                const messageBox = document.getElementById('message-box');
                const messageText = document.getElementById('message-text');
                messageText.textContent = text;
                messageBox.classList.remove('hidden');
                setTimeout(() => { messageBox.classList.add('hidden'); }, 2000); // 메시지 표시 시간 단축
            }

            function updateHighlights(slot) {
                highlightPieces.forEach(el => {
                    el.style.opacity = el.id === `highlight-${slot}` ? '1' : '0';
                });
            }

            function handleDrop(targetElement, menuName, originalSrc, category) {
                if (!targetElement || targetElement.dataset.slot === undefined) return;
                
                const slot = targetElement.dataset.slot;

                // ✨ 드롭 직전에 최종적으로 위치가 맞는지 한 번 더 확인
                if (!isDropAllowed(category, slot)) {
                    showMessage("해당 위치에 놓을 수 없는 메뉴입니다.");
                    return; // 규칙에 맞지 않으면 함수 종료
                }
                
                const suffix = (slot === '4') ? '_p2.png' : '_p.png';
                const newSrc = originalSrc.replace('.png', suffix);
                targetElement.src = newSrc;
                document.getElementById(`menu_${parseInt(slot) + 1}`).value = menuName;
                updateHighlights(null);
            }

            function renderMenu(category) {
                menuGallery.innerHTML = '';
                const items = menuData[category];
                items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex flex-col items-center cursor-pointer';
                    const itemImage = document.createElement('img');
                    itemImage.src = item.src;
                    itemImage.alt = item.name;
                    itemImage.className = 'rounded-full w-24 h-24 object-cover menu-item-img';
                    itemImage.dataset.name = item.name;
                    itemImage.dataset.category = category; // ✨ 이미지에 카테고리 정보 추가
                    itemImage.draggable = true;
                    const itemSpan = document.createElement('span');
                    itemSpan.className = 'mt-2 text-sm text-center';
                    itemSpan.textContent = item.name;
                    itemDiv.appendChild(itemImage);
                    itemDiv.appendChild(itemSpan);
                    menuGallery.appendChild(itemDiv);
                });
            }

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const category = tab.id.replace('-tab', '');
                    renderMenu(category);
                });
            });

            renderMenu('chicken');

            // --- PC 드래그 이벤트 ---
            document.addEventListener('dragstart', function(event) {
                if (event.target.classList.contains('menu-item-img')) {
                    const target = event.target;
                    event.dataTransfer.setData('text/plain', target.dataset.name);
                    event.dataTransfer.setData('original-src', target.src);
                    event.dataTransfer.setData('category', target.dataset.category); // ✨ 카테고리 정보 전달
                    draggedCategory = target.dataset.category; // ✨ 드래그 시작 시 카테고리 저장
                }
            });

            document.addEventListener('dragover', function(event) {
                event.preventDefault();
                const hoveredTarget = document.elementFromPoint(event.clientX, event.clientY);
                if (hoveredTarget && hoveredTarget.dataset.slot !== undefined) {
                    // ✨ 허용된 위치에만 하이라이트 표시
                    if (isDropAllowed(draggedCategory, hoveredTarget.dataset.slot)) {
                        updateHighlights(hoveredTarget.dataset.slot);
                    } else {
                        updateHighlights(null);
                    }
                } else {
                    updateHighlights(null);
                }
            });

            document.addEventListener('dragend', function(event) {
                updateHighlights(null);
                draggedCategory = null; // ✨ 드래그 종료 시 카테고리 초기화
            });

            document.addEventListener('drop', function(event) {
                event.preventDefault();
                const menuName = event.dataTransfer.getData('text/plain');
                const originalSrc = event.dataTransfer.getData('original-src');
                const category = event.dataTransfer.getData('category'); // ✨ 카테고리 정보 받기
                
                if (menuName && originalSrc) {
                    const droppedTarget = document.elementFromPoint(event.clientX, event.clientY);
                    handleDrop(droppedTarget, menuName, originalSrc, category); // ✨ handleDrop에 카테고리 전달
                }
                updateHighlights(null);
            });

            // --- 모바일 터치 이벤트 ---
            document.addEventListener('touchstart', function(event) {
                if (event.target.classList.contains('menu-item-img')) {
                    const target = event.target;
                    draggedElement = target;
                    draggedMenuName = target.dataset.name;
                    draggedOriginalSrc = target.src;
                    draggedCategory = target.dataset.category; // ✨ 터치 시작 시 카테고리 저장
                }
            }, { passive: false });

            document.addEventListener('touchmove', function(event) {
                if (!draggedElement) return;
                event.preventDefault();
                const touch = event.touches[0];
                const hoveredTarget = document.elementFromPoint(touch.clientX, touch.clientY);

                if (hoveredTarget && hoveredTarget.dataset.slot !== undefined) {
                    // ✨ 허용된 위치에만 하이라이트 표시
                    if (isDropAllowed(draggedCategory, hoveredTarget.dataset.slot)) {
                        updateHighlights(hoveredTarget.dataset.slot);
                    } else {
                        updateHighlights(null);
                    }
                } else {
                    updateHighlights(null);
                }
            }, { passive: false });

            document.addEventListener('touchend', function(event) {
                if (!draggedElement) return;
                const touch = event.changedTouches[0];
                const droppedTarget = document.elementFromPoint(touch.clientX, touch.clientY);
                
                if (droppedTarget && droppedTarget.dataset.slot !== undefined) {
                    // ✨ handleDrop에 카테고리 전달
                    handleDrop(droppedTarget, draggedMenuName, draggedOriginalSrc, draggedCategory);
                }

                // ✨ 드래그 종료 시 상태 초기화
                draggedElement = null;
                draggedMenuName = null;
                draggedOriginalSrc = null;
                draggedCategory = null;
                updateHighlights(null);
            }, { passive: false });

            document.getElementById('event-form').addEventListener('submit', function(event) {
                // ... (폼 제출 로직은 변경 없음) ...
            });
        });
    </script>
</body>
</html>